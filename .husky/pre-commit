#!/bin/sh

echo "ğŸ” Pre-commit ê²€ì¦ ì‹œì‘..."

# 0. Staged íŒŒì¼ ìë™ í¬ë§·(Prettier)
echo "âœ¨ í¬ë§·íŒ…(Prettier) + ì¬ìŠ¤í…Œì´ì§•..."
npx lint-staged
if [ $? -ne 0 ]; then
    echo "âŒ í¬ë§·íŒ… ì‹¤íŒ¨! ì»¤ë°‹ ì¤‘ë‹¨."
    exit 1
fi

# 1. Core íŒ¨í‚¤ì§€ export ê²€ì¦
echo "ğŸ“¦ Core ëª¨ë“ˆ export ê²€ì¦..."
node scripts/check-exports.js
if [ $? -ne 0 ]; then
    echo "âŒ Core ëª¨ë“ˆ export ê²€ì¦ ì‹¤íŒ¨!"
    exit 1
fi

# 2. Core íŒ¨í‚¤ì§€ ë³€ê²½ ê°ì§€ ì‹œ ë¹Œë“œ ê²€ì¦
if git diff --cached --name-only | grep -q "packages/core/src"; then
    echo "ğŸ”¨ Core íŒ¨í‚¤ì§€ ë³€ê²½ ê°ì§€ - ë¹Œë“œ ê²€ì¦..."
    cd packages/core && npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ Core ë¹Œë“œ ì‹¤íŒ¨! ì»¤ë°‹ ì¤‘ë‹¨."
        exit 1
    fi
    cd ../..
fi

# 3. TypeScript íƒ€ì… ì²´í¬
echo "ğŸ“ TypeScript íƒ€ì… ê²€ì‚¬..."
npm run typecheck
if [ $? -ne 0 ]; then
    echo "âŒ TypeScript ì—ëŸ¬ ë°œê²¬! ì»¤ë°‹ ì¤‘ë‹¨."
    exit 1
fi

# 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìŠ¤ëƒ…ìƒ· ê²€ì¦)
echo "ğŸ§ª í…ŒìŠ¤íŠ¸(ìŠ¤ëƒ…ìƒ·) ê²€ì¦..."
npm test
if [ $? -ne 0 ]; then
    echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ë¡œì§ì´ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ìŠ¤ëƒ…ìƒ·ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
    echo "   ì˜ë„ì ì¸ ë³€ê²½ì´ë¼ë©´ 'npm test -- -u' ëª…ë ¹ì–´ë¡œ ìŠ¤ëƒ…ìƒ·ì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”."
    exit 1
fi

echo "âœ… Pre-commit ê²€ì¦ ì™„ë£Œ!"
